name: Continuous Integration

on:
  push:
    branches:
      - develop
    paths-ignore:
      - "**.md"
      - "renovate.json"
      - ".github/ISSUE_TEMPLATE/**"
      - ".github/workflows/release.yml"

  pull_request:
    paths-ignore:
      - "**.md"
      - "renovate.json"
      - ".github/ISSUE_TEMPLATE/**"
      - ".github/workflows/release.yml"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  code-coverage:
      name: Code Coverage
      runs-on: ubuntu-latest
      permissions:
        contents: read

      steps:
          - name: Checkout
            uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
            with:
                fetch-depth: 0
                show-progress: false

          - name: Setup .NET
            uses: actions/setup-dotnet@2016bd2012dba4e32de620c46fe006a3ac9f0602 # v5.0.1
            with:
                global-json-file: global.json
                cache: true
                cache-dependency-path: '**/Directory.Packages.props'

          - name: Cache SonarCloud scanner
            uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
            with:
                path: .sonar/scanner
                key: ${{ runner.os }}-sonar-scanner
                restore-keys: ${{ runner.os }}-sonar-scanner

          - name: Install tools
            run: |
              if [ ! -d ".sonar/scanner" ]; then
                mkdir -p .sonar/scanner
                dotnet tool update dotnet-sonarscanner --tool-path .sonar/scanner
              fi
              dotnet tool install --global dotnet-coverage

          - name: Restore dependencies
            run: dotnet restore

          - name: Begin SonarCloud analysis
            env:
              SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
            run: |
              .sonar/scanner/dotnet-sonarscanner begin \
                /k:"visus:cuid.net" \
                /o:"visus" \
                /d:sonar.token="$SONAR_TOKEN" \
                /d:sonar.cs.vscoveragexml.reportsPaths="${{ github.workspace }}/TestResults/**/*.xml" \
                /d:sonar.cs.vstest.reportsPaths="${{ github.workspace }}/TestResults/**/*.trx" \
                /d:sonar.host.url="https://sonarcloud.io"

          - name: Build
            run: dotnet build -c Release --no-restore

          - name: Run tests with coverage
            run: |
              dotnet-coverage collect \
                --output "${{ github.workspace }}/TestResults/coverage.coverage" \
                --output-format coverage \
                -- dotnet test -c Release \
                   --framework net10.0 \
                   --no-build \
                   --report-trx \
                   --results-directory "${{ github.workspace }}/TestResults"

          - name: Convert coverage to XML
            run: |
              dotnet-coverage merge \
                "${{ github.workspace }}/TestResults/coverage.coverage" \
                --output "${{ github.workspace }}/TestResults/coverage.xml" \
                --output-format xml

          - name: End SonarCloud analysis
            env:
              SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
            run: |
              .sonar/scanner/dotnet-sonarscanner end \
                /d:sonar.token="$SONAR_TOKEN"
          
  unit-tests:
    name: Unit Tests (${{ matrix.framework }})
    runs-on: windows-latest
    permissions:
      contents: read
    strategy:
      matrix:
        framework: [net8.0, net10.0, net48]

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          show-progress: false

      - name: Setup .NET
        uses: actions/setup-dotnet@2016bd2012dba4e32de620c46fe006a3ac9f0602 # v5.0.1
        with:
          global-json-file: global.json
          cache: true
          cache-dependency-path: '**/Directory.Packages.props'

      - name: Restore dependencies
        run: dotnet restore

      - name: Run tests
        shell: powershell
        run: |
            dotnet test -c Release --framework ${{ matrix.framework }} `
              --no-restore `
              --report-trx `
              --results-directory "${{ runner.temp }}\TestResults"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: test-results-${{ matrix.framework }}
          path: ${{ runner.temp }}\TestResults\*.trx
          retention-days: 1

  publish-test-results:
    name: Publish Test Results
    runs-on: ubuntu-latest
    needs: unit-tests
    if: always()
    permissions:
      contents: read
      checks: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Download all test results
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          pattern: test-results-*
          path: test-results
          merge-multiple: true

      - name: Publish test results
        uses: dorny/test-reporter@31a54ee7ebcacc03a09ea97a7e5465a47b84aea5 # v1.9.1
        with:
          name: Test Results
          path: test-results/*.trx
          reporter: dotnet-trx
          fail-on-error: false
