name: Continuous Integration

on:
  push:
    branches:
      - develop
    paths-ignore:
      - "**.md"
      - "renovate.json"
      - ".github/ISSUE_TEMPLATE/**"
      - ".github/workflows/release.yml"

  pull_request:
    paths-ignore:
      - "**.md"
      - "renovate.json"
      - ".github/ISSUE_TEMPLATE/**"
      - ".github/workflows/release.yml"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  unit-tests:
    name: Unit Tests (${{ matrix.framework }})
    runs-on: windows-latest
    strategy:
      matrix:
        framework: [net8.0, net10.0, net48]

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          show-progress: false

      - name: Setup .NET
        uses: actions/setup-dotnet@d4c94342e560b34958eacfc5d055d21461ed1c5d # v5.0.0
        with:
          global-json-file: global.json
          cache: true
          cache-dependency-path: '**/Directory.Packages.props'

      - name: Restore dependencies
        run: dotnet restore

      - name: Run tests
        shell: powershell
        run: |
            dotnet test -c Release --framework ${{ matrix.framework }} `
              --no-restore `
              --coverage `
              --coverage-output "${{ runner.temp }}\coverage-${{ matrix.framework }}.coverage" `
              --report-trx `
              --results-directory "${{ runner.temp }}\TestResults"

      - name: Upload coverage
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: coverage-${{ matrix.framework }}
          path: ${{ runner.temp }}\coverage-${{ matrix.framework }}.coverage
          retention-days: 1

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: test-results-${{ matrix.framework }}
          path: ${{ runner.temp }}\TestResults\*.trx
          retention-days: 1

  publish-test-results:
    name: Publish Test Results
    runs-on: ubuntu-latest
    needs: unit-tests
    if: always()
    permissions:
      contents: read
      checks: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Download all test results
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          pattern: test-results-*
          path: test-results
          merge-multiple: true

      - name: Publish test results
        uses: dorny/test-reporter@31a54ee7ebcacc03a09ea97a7e5465a47b84aea5 # v1.9.1
        with:
          name: Test Results
          path: test-results/*.trx
          reporter: dotnet-trx
          fail-on-error: false

  sonarcloud:
    name: SonarCloud Analysis
    runs-on: windows-latest
    needs: unit-tests
    if: always()
    env:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          show-progress: false

      - name: Setup .NET
        uses: actions/setup-dotnet@d4c94342e560b34958eacfc5d055d21461ed1c5d # v5.0.0
        with:
          global-json-file: global.json
          cache: true
          cache-dependency-path: '**/Directory.Packages.props'

      - name: Setup Java
        uses: actions/setup-java@7a6d8a8234af8eb26422e24e3006232cccaa061b # v4.6.0
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache SonarCloud scanner
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
        with:
          path: .sonar\scanner
          key: ${{ runner.os }}-sonar-scanner
          restore-keys: ${{ runner.os }}-sonar-scanner

      - name: Download all coverage artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          pattern: coverage-*
          path: coverage
          merge-multiple: true

      - name: Download all test result artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          pattern: test-results-*
          path: test-results
          merge-multiple: true

      - name: Restore dependencies
        run: dotnet restore

      - name: Install SonarCloud scanner
        shell: powershell
        run: dotnet tool update dotnet-sonarscanner --tool-path .\.sonar\scanner

      - name: Install dotnet-coverage
        run: dotnet tool install -g dotnet-coverage

      - name: Merge and convert coverage
        shell: powershell
        run: |
          dotnet-coverage merge coverage\*.coverage `
            --output coverage\coverage-report.xml `
            --output-format xml

      - name: Run SonarCloud analysis
        shell: powershell
        run: |
          .\.sonar\scanner\dotnet-sonarscanner begin `
            /k:"visus:cuid.net" `
            /o:"visus" `
            /d:sonar.token="${{ secrets.SONAR_TOKEN }}" `
            /d:sonar.cs.vscoveragexml.reportsPaths="coverage\coverage-report.xml" `
            /d:sonar.cs.vstest.reportsPaths="test-results\*.trx" `
            /d:sonar.host.url="https://sonarcloud.io"

          dotnet build -c Release --no-restore

          .\.sonar\scanner\dotnet-sonarscanner end `
            /d:sonar.token="${{ secrets.SONAR_TOKEN }}"
